# Rolling Update and Rolling Back practice guide

In this Exercise:

a. You will create deploy sample application. Next we will update deployment by setting new Image version.
b. What if we incorrectly put Image version? we will "undo" rollout. You will also learn about rolling back.

NOTE: 
-----
a. To successfully finish this exercise, It is important to go through Rolling Update & Rolling Back Concept and Demo videos in this series.
b. You can refer to Kuberenetes Docs for help when needed.

STEP-1: Create Deployment:
--------------------------
a. Create the deployment with below configuration using "kubectl create...." command.

- Deployment Name: nginx-deploy
- Container Image: nginx:1.18
- Replicas: 3

```bash
kubectl create deploy nginx-deploy --image nginx:1.18 --replicas 3
```

STEP-2: Validate the Deployment:
--------------------------------
a. Display "nginx-deploy" deployment. Ensure Container Image version is nginx "1.18"

```bash
kubectl get deploy nginx-deploy -o wide
NAME           READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES       SELECTOR
nginx-deploy   3/3     3            3           76s   nginx        nginx:1.18   app=nginx-deploy
```

STEP-3: Upgrading Deployment with new Image:
--------------------------------------------
a. Upgrade "nginx-deploy" deployment nginx version from 1.18 to 1.91 using "..set image..." command with manual annotation (optional)

```bash
kubectl set image deployment/nginx-deploy nginx=nginx:1.91
```

```bash
kubectl annotate deployment nginx-deploy kubernetes.io/change-cause="Actualización a nginx:1.91"
```

b. Wait for a minute and display roll-out status of "nginx-deploy" deployment.

```bash
kubectl rollout status deploy nginx-deploy
Waiting for deployment "nginx-deploy" rollout to finish: 1 out of 3 new replicas have been updated...
```

c. In case if it is "stuck", then display "roll-out history" of "nginx-deploy" deployment. 
d. Identify Issue

```bash
kubectl rollout history deploy nginx-deploy
deployment.apps/nginx-deploy 
REVISION  CHANGE-CAUSE
1         <none>
2         Actualización a nginx:1.91
```

TEP-4: Doing previous rollout "undo":
--------------------------------------
a. Undo previous upgrade using "..rollout undo..." command

```bash
kubectl rollout undo deployment/nginx-deploy --to-revision=0
deployment.apps/nginx-deploy rolled back
```

b. Ensure "nginx-deploy" is running with image version nginx "1.18"
```bash
kubectl get deploy nginx-deploy -o wide
NAME           READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES       SELECTOR
nginx-deploy   3/3     3            3           22m   nginx        nginx:1.18   app=nginx-deploy
```

STEP-5: Upgrading Deployment with new Image:
--------------------------------------------
a. Upgrade "nginx-deploy" deployment nginx version from 1.18 to 1.19 using "..set image..." command with manual annotation on

```bash
kubectl set image deployment/nginx-deploy nginx=nginx:1.19
```

b. Wait for a minute and display roll-out status of "nginx-deploy" deployment.
c. Display upgrade status by running "....rollout status..."

```bash
kubectl rollout status deploy nginx-deploy
deployment "nginx-deploy" successfully rolled out
```

d. Display "nginx-deploy" deployment and ensure it is running with image version nginx "1.19"

```bash
kubectl get deploy nginx-deploy -o wide
NAME           READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES       SELECTOR
nginx-deploy   3/3     3            3           28m   nginx        nginx:1.19   app=nginx-deploy
```

STEP-6: Delete Deployment:
--------------------------
a. Delete the "nginx-deploy" deployment. 

```bash
kubectl delete deploy nginx-deploy --force
Warning: Immediate deletion does not wait for confirmation that the running resource has been terminated. The resource may continue to run on the cluster indefinitely.
deployment.apps "nginx-deploy" force deleted
```

b. Display Deployment, ReplicaSet and Pods. Ensure "nginx-deploy" Deployemnt is related. Also related ReplicaSet and Pods

```bash
kubectl get pods | grep nginx-deploy
No resources found in default namespace.

kubectl get rs | grep nginx-deploy
No resources found in default namespace.
```





